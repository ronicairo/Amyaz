<?php

$accented_chars = [
    ['accented' => 'à', 'simple' => 'a'],
    ['accented' => 'á', 'simple' => 'a'],
    ['accented' => 'â', 'simple' => 'a'],
    ['accented' => 'ä', 'simple' => 'a'],
    ['accented' => 'ã', 'simple' => 'a'],
    ['accented' => 'å', 'simple' => 'a'],
    ['accented' => 'ā', 'simple' => 'a'],
    ['accented' => 'ă', 'simple' => 'a'],
    ['accented' => 'ą', 'simple' => 'a'],
    ['accented' => 'æ', 'simple' => 'ae'],
    ['accented' => 'ç', 'simple' => 'c'],
    ['accented' => 'ć', 'simple' => 'c'],
    ['accented' => 'ĉ', 'simple' => 'c'],
    ['accented' => 'ċ', 'simple' => 'c'],
    ['accented' => 'č', 'simple' => 'c'],
    ['accented' => 'ď', 'simple' => 'd'],
    ['accented' => 'đ', 'simple' => 'd'],
    ['accented' => 'è', 'simple' => 'e'],
    ['accented' => 'é', 'simple' => 'e'],
    ['accented' => 'ê', 'simple' => 'e'],
    ['accented' => 'ë', 'simple' => 'e'],
    ['accented' => 'ē', 'simple' => 'e'],
    ['accented' => 'ĕ', 'simple' => 'e'],
    ['accented' => 'ė', 'simple' => 'e'],
    ['accented' => 'ę', 'simple' => 'e'],
    ['accented' => 'ě', 'simple' => 'e'],
    ['accented' => 'ĝ', 'simple' => 'g'],
    ['accented' => 'ğ', 'simple' => 'g'],
    ['accented' => 'ġ', 'simple' => 'g'],
    ['accented' => 'ģ', 'simple' => 'g'],
    ['accented' => 'ĥ', 'simple' => 'h'],
    ['accented' => 'ħ', 'simple' => 'h'],
    ['accented' => 'ì', 'simple' => 'i'],
    ['accented' => 'í', 'simple' => 'i'],
    ['accented' => 'î', 'simple' => 'i'],
    ['accented' => 'ï', 'simple' => 'i'],
    ['accented' => 'ĩ', 'simple' => 'i'],
    ['accented' => 'ī', 'simple' => 'i'],
    ['accented' => 'ĭ', 'simple' => 'i'],
    ['accented' => 'į', 'simple' => 'i'],
    ['accented' => 'ı', 'simple' => 'i'],
    ['accented' => 'ĵ', 'simple' => 'j'],
    ['accented' => 'ķ', 'simple' => 'k'],
    ['accented' => 'ĸ', 'simple' => 'k'],
    ['accented' => 'ĺ', 'simple' => 'l'],
    ['accented' => 'ļ', 'simple' => 'l'],
    ['accented' => 'ľ', 'simple' => 'l'],
    ['accented' => 'ŀ', 'simple' => 'l'],
    ['accented' => 'ł', 'simple' => 'l'],
    ['accented' => 'ñ', 'simple' => 'n'],
    ['accented' => 'ń', 'simple' => 'n'],
    ['accented' => 'ņ', 'simple' => 'n'],
    ['accented' => 'ň', 'simple' => 'n'],
    ['accented' => 'ŉ', 'simple' => 'n'],
    ['accented' => 'ŋ', 'simple' => 'nj'],
    ['accented' => 'ò', 'simple' => 'o'],
    ['accented' => 'ó', 'simple' => 'o'],
    ['accented' => 'ô', 'simple' => 'o'],
    ['accented' => 'ö', 'simple' => 'o'],
    ['accented' => 'õ', 'simple' => 'o'],
    ['accented' => 'ø', 'simple' => 'o'],
    ['accented' => 'ō', 'simple' => 'o'],
    ['accented' => 'ŏ', 'simple' => 'o'],
    ['accented' => 'ő', 'simple' => 'o'],
    ['accented' => 'œ', 'simple' => 'oe'],
    ['accented' => 'ŕ', 'simple' => 'r'],
    ['accented' => 'ŗ', 'simple' => 'r'],
    ['accented' => 'ř', 'simple' => 'r'],
    ['accented' => 'ś', 'simple' => 's'],
    ['accented' => 'ŝ', 'simple' => 's'],
    ['accented' => 'ş', 'simple' => 's'],
    ['accented' => 'š', 'simple' => 's'],
    ['accented' => 'ţ', 'simple' => 't'],
    ['accented' => 'ť', 'simple' => 't'],
    ['accented' => 'ŧ', 'simple' => 't'],
    ['accented' => 'ù', 'simple' => 'u'],
    ['accented' => 'ú', 'simple' => 'u'],
    ['accented' => 'û', 'simple' => 'u'],
    ['accented' => 'ü', 'simple' => 'u'],
    ['accented' => 'ũ', 'simple' => 'u'],
    ['accented' => 'ū', 'simple' => 'u'],
    ['accented' => 'ŭ', 'simple' => 'u'],
    ['accented' => 'ů', 'simple' => 'u'],
    ['accented' => 'ű', 'simple' => 'u'],
    ['accented' => 'ų', 'simple' => 'u'],
    ['accented' => 'ŵ', 'simple' => 'w'],
    ['accented' => 'ý', 'simple' => 'y'],
    ['accented' => 'ÿ', 'simple' => 'y'],
    ['accented' => 'ŷ', 'simple' => 'y'],
    ['accented' => 'ź', 'simple' => 'z'],
    ['accented' => 'ż', 'simple' => 'z'],
    ['accented' => 'ž', 'simple' => 'z'],

];

// Set the database connection parameters
$host = 'phpmyadmin.viaduc.fr';
$dbname = 'h20465_amyazvocab';
$username = 'h20465';
$password = '8parDX3I';

// Establish a database connection
$pdo = new PDO("mysql:host=$host;dbname=$dbname;charset=utf8", $username, $password);

// Get the search query from the request parameters
$searchQuery = $_GET['q'];

// Create a prepared statement to select matching rows from the database
$stmt = $pdo->prepare("SELECT LOCATE(:search, title) AS position, title, content, address, pluriel FROM blog WHERE title LIKE :searchlike COLLATE utf8_general_ci ORDER BY position ASC");

// Bind the search query to the prepared statement
$searchParam = "$searchQuery";
$searchParamLike = "%$searchQuery%";
$remove_0 = false;
$start_with = false;
foreach ( $accented_chars as $accented_char ) {
    if ( $searchQuery == $accented_char['accented'] ) {
        $searchParamLike = "$searchQuery%";
        $remove_0 = true;
        $start_with = $accented_char['accented'];
    }
}
$stmt->bindParam(':search', $searchParam);
$stmt->bindParam(':searchlike', $searchParamLike);

// Execute the prepared statement
$stmt->execute();

// Fetch the results as an associative array
$results = $stmt->fetchAll(PDO::FETCH_ASSOC);


foreach ($results as $key => $result) {
    if ( $remove_0 AND $result['position'] == 0 ) {
        unset($results[$key]);
    }
}
$results = array_values( $results );

foreach ($results as $key => $result) {
    $postion_value = strlen($result['title']) / 5;
    $eval_string = $result['title'];

    if ( $result['position'] == 0 ) {
        foreach ( $accented_chars as $accented_char ) {
            $eval_string = str_replace( $accented_char['accented'], $accented_char['simple'], $eval_string );
        }
        $position = strpos( $eval_string, $searchQuery );
        $postion_value = strlen($eval_string) / 5;
        $results[$key]['position'] = $position + 1.1;
    }
    if ( $start_with != false ) {
        if ( strpos( $eval_string, $start_with ) === 0 ) {
            $results[$key]['position'] -= 10;
        }
    }

    $results[$key]['position'] += $postion_value;
}


function cmp($a, $b) {
    if (abs($a['position'] - $b['position']) < 0.0001) {
        return strlen($a['title']) - strlen($b['title']);
    }
    return ($a['position'] < $b['position']) ? -1 : 1;
}
usort($results, 'cmp');

if (count($results) > 15) {
    $remove_count = count($results) - 15;
    array_splice($results, -$remove_count);
}

// Encode the results as JSON and send them back to the client
echo json_encode($results);