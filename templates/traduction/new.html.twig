{% extends 'base.html.twig' %}

{% form_theme form 'form/_form_errors.html.twig' %}

{% block title %}
    {% if is_granted('ROLE_ADMIN') or is_granted('ROLE_MODERATOR') %}
        {{ 'post.new_trad_admin'|trans }}
    {% else %}
        {{ 'post.new_trad'|trans }}
    {% endif %}
{% endblock %}

{% block body %}

<style>
audio {
    width: 100%;
    margin-top: 8px;
    border-radius: 10px;
}
/* ========================================
   NEW TRADUCTION - MODERN STYLE
   ======================================== */

.new-trad-page {
    min-height: 80vh;
    padding: 60px 20px;
    display: flex;
    justify-content: center;
    animation: fadeInPage 0.4s ease;
}

@keyframes fadeInPage {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}

.new-trad-card {
    width: 100%;
    max-width: 900px;
    background: white;
    border-radius: 24px;
    box-shadow: 0 15px 50px rgba(26,40,77,0.1);
    padding: 40px;
    position: relative;
    overflow: hidden;
}

.new-trad-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, #1a284d, #b3e2ec);
    border-top-left-radius: 24px;
    border-top-right-radius: 24px;
}

/* Title */
.new-trad-title {
    text-align: center;
    margin-bottom: 35px;
}

.new-trad-title h1 {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    color: #1a284d;
}

/* Required text */
.required-info {
    text-align: center;
    color: #999;
    font-size: 14px;
    margin-bottom: 25px;
}

/* Grid layout */
.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px 30px;
}

/* Full width fields */
.full-width {
    grid-column: 1 / -1;
}

/* Form fields */
.form-modern input,
.form-modern textarea,
.form-modern select {
    width: 100%;
    padding: 14px 16px;
    border-radius: 12px;
    border: 1px solid #e0e0e0;
    font-size: 15px;
    transition: all 0.3s ease;
}

.form-modern textarea {
    min-height: 120px;
    resize: vertical;
}

.form-modern input:focus,
.form-modern textarea:focus,
.form-modern select:focus {
    border-color: #1a284d;
    box-shadow: 0 0 0 3px rgba(26,40,77,0.08);
    outline: none;
}

/* Submit */
.submit-trad-btn {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    border: none;
    background: linear-gradient(135deg, #1a284d, #2d4a7c);
    color: white;
    font-weight: 600;
    font-size: 1rem;
    margin-top: 30px;
    transition: all 0.3s ease;
}

.submit-trad-btn:hover {
    transform: translateY(-2px);
}

/* Responsive */
@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }

    .new-trad-card {
        padding: 25px;
    }
}
.audio-recorder {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.audio-recorder button {
    padding: 8px 12px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: #1a284d;
    color: white;
}

.audio-recorder button:disabled {
    opacity: 0.5;
}
</style>

<div class="col-11 col-md-8 col-lg-6 mx-auto mb-4">
    {% include 'include/flashes.html.twig' %}
</div>

<div class="new-trad-page">
    <div class="new-trad-card">

        <div class="new-trad-title">
            <h1>
                {% if is_granted('ROLE_ADMIN') or is_granted('ROLE_MODERATOR') %}
                    {{ 'post.new_trad_admin'|trans }}
                {% else %}
                    {{ 'post.new_trad'|trans }}
                {% endif %}
            </h1>
        </div>

        <div class="required-info">
            {{ 'post.champ_obligatoire'|trans }}
        </div>

        {{ form_start(form) }}

        <div class="form-grid form-modern">

        {% if is_granted('ROLE_ADMIN') or is_granted('ROLE_MODERATOR') %}

            {{ form_row(form.wordFR, {'row_attr': {'class': 'full-width'}}) }}
            {{ form_row(form.grammarFR) }}

            {{ form_row(form.wordEN) }}
            {{ form_row(form.grammarEN) }}

            {{ form_row(form.singular) }}
            {{ form_row(form.plural) }}

            {{ form_row(form.phoneticSingular) }}
            {{ form_row(form.phoneticPlural) }}

            {{ form_row(form.origin, {'row_attr': {'class': 'full-width'}}) }}
            {{ form_row(form.racine) }}

            {{ form_row(form.example, {'row_attr': {'class': 'full-width'}}) }}
            {{ form_row(form.source) }}

        {% else %}

            {% if locale == 'fr' %}
                {{ form_row(form.wordFR) }}
                {{ form_row(form.grammarFR) }}
            {% elseif locale == 'en' %}
                {{ form_row(form.wordEN) }}
                {{ form_row(form.grammarEN) }}
            {% endif %}

            {{ form_row(form.singular) }}
            {{ form_row(form.plural) }}

            {{ form_row(form.phoneticSingular) }}
            {{ form_row(form.phoneticPlural) }}

        {% endif %}

<div class="full-width">
    <label>Rifain Singulier (audio)</label>

    {{ form_widget(form.rifainSingularRecord, {
        attr: { style: 'display:none;' }
    }) }}

    <div class="audio-recorder">
        <button type="button" id="startSingular">üé§ Enregistrer</button>
        <button type="button" id="stopSingular" disabled>‚èπ Stop</button>
        <input type="file" accept="audio/*" id="uploadSingular">
    </div>

    <audio id="previewSingular" controls style="display:none;"></audio>
</div>

<div class="full-width">
    <label>Rifain Pluriel (audio)</label>

    {{ form_widget(form.rifainPluralRecord, {
        attr: { style: 'display:none;' }
    }) }}

    <div class="audio-recorder">
        <button type="button" id="startPlural">üé§ Enregistrer</button>
        <button type="button" id="stopPlural" disabled>‚èπ Stop</button>
        <input type="file" accept="audio/*" id="uploadPlural">
    </div>

    <audio id="previewPlural" controls style="display:none;"></audio>
</div>

    <div class="full-width">
    {{ form_row(form.submit) }}
</div>

{{ form_row(form.captcha) }}

{{ form_end(form) }}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

    async function setupRecorder(startBtnId, stopBtnId, previewId, fileInputId, hiddenInputId) {

        let mediaRecorder;
        let audioChunks = [];

        const startBtn = document.getElementById(startBtnId);
        const stopBtn = document.getElementById(stopBtnId);
        const preview = document.getElementById(previewId);
        const uploadInput = document.getElementById(fileInputId);
        const hiddenFileInput = document.getElementById(hiddenInputId);

        // üé§ ENREGISTREMENT MICRO
        startBtn.addEventListener('click', async () => {

            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();

            startBtn.disabled = true;
            stopBtn.disabled = false;

            audioChunks = [];

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(audioBlob);

                preview.src = audioUrl;
                preview.style.display = 'block';

                // Inject blob into Symfony FileType
                const file = new File([audioBlob], "record.webm");
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                hiddenFileInput.files = dataTransfer.files;
            };
        });

        stopBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            startBtn.disabled = false;
            stopBtn.disabled = true;
        });

        // üìÅ UPLOAD FICHIER CLASSIQUE
        uploadInput.addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                preview.src = url;
                preview.style.display = 'block';

                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                hiddenFileInput.files = dataTransfer.files;
            }
        });
    }

    setupRecorder(
        "startSingular",
        "stopSingular",
        "previewSingular",
        "uploadSingular",
        "{{ form.rifainSingularRecord.vars.id }}"
    );

    setupRecorder(
        "startPlural",
        "stopPlural",
        "previewPlural",
        "uploadPlural",
        "{{ form.rifainPluralRecord.vars.id }}"
    );

});
</script>

{% endblock %}